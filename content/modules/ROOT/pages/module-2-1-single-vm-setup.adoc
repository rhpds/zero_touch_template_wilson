= Module 2.1: Single VM Setup
:estimated-time: 15-20 minutes

== Learning Objectives

Upon completion, you will understand:

* VM configuration creation from scratch
* Essential VM parameters and their purposes
* Template file modification procedures
* Configuration file validation methods

== Overview

In this hands-on module, replace the existing `host1` VM (from the official template at https://github.com/rhpds/lab_zero_touch_template.git) with your own lab server. This is the foundation for any Zero Touch lab.

== Step 1: Plan Your VM

Before editing configuration files, clarify your requirements:

**Lab Scenario**: Basic RHEL administration training  
**VM Purpose**: Single server for learning Linux commands  
**Requirements**:
- RHEL 9.6 operating system
- 4GB RAM (sufficient for multiple processes)
- 2 CPU cores (for responsive performance)
- 40GB disk (ample for packages and data)
- Network connectivity

== Step 2: Create the VM Configuration

Edit `config/instances.yaml` to replace the "host1" VM with your new lab server.

=== Current Configuration

First, review the current configuration:

.View Current Configuration <<template-instances>>
[source,bash]
----
cat config/instances.yaml
----

You should see something similar to:
.Current Official Template Configuration <<template-instances>>
[source,yaml]
----
virtualmachines:
  - name: "host1"
    image: "rhel-9.6"
    memory: "4G"
    cores: 1
    image_size: "40G"
    tags:
      - key: "AnsibleGroup"
        value: "bastions"
    networks:
      - default
----

=== Replace with Lab Server

Replace the entire `virtualmachines` section with your lab server definition:

.Lab Server VM Configuration <<roadshow-instances>>
[source,yaml]
----
virtualmachines:
  - name: "lab-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    networks:
      - default
    packages:
      - git
      - vim
      - tree
      - htop
    tags:
      - key: "AnsibleGroup"
        value: "bastions"        # ‚Üê REQUIRED for deployment
      - key: "ostype"
        value: "linux"
      - key: "Purpose"
        value: "Training"
----

=== Understanding Each Parameter

[cols="1,1,3"]
|===
|Parameter |Value |Purpose

|`name`
|`"lab-server"`
|Unique identifier for this VM

|`image` 
|`"rhel-9.6"`
|Operating system to install

|`memory`
|`"4G"`
|RAM allocation (4 gigabytes)

|`cores`
|`2`
|Number of CPU cores

|`image_size`
|`"40G"`
|Disk size (40 gigabytes)

|`networks`
|`- default`
|Networks to connect to (see <<agnosticd-base>>)

|`packages`
|List of packages
|Software to pre-install

|`tags`
|Key-value pairs
|Metadata for automation and organization
|===

[IMPORTANT]
====
**At least ONE VM must have the "bastions" Ansible group tag** for Zero Touch deployment to succeed.  
See <<template-instances>> for required tags.

The bastion host provides SSH access, user accounts, and terminal integration. In single-VM labs, this is your main server. In multi-tier labs, designate one VM as the bastion (usually a management/jump server) while others can use different Ansible groups such as "webservers" or "databases".
====

== Step 3: Update the UI Configuration

The current UI configuration references the "host1" VM (from the official template). Update it to point to your new "lab-server".

=== Check Current UI Config

.View UI Configuration <<template-ui>>
[source,bash]
----
cat ui-config.yml
----

Look for the `tabs` section. You should see:
.Current UI Tab Configuration <<template-ui>>
[source,yaml]
----
tabs:
  - name: ">_ terminal"
    url: /wetty_host1/ssh/root
----

=== Update to Lab Server

Replace the tab configuration to point to your lab server's terminal:

.Updated Lab Server UI Configuration <<satellite-ui>>
[source,yaml]
----
tabs:
  - name: ">_ lab-server"
    url: /wetty_lab-server/ssh/root
  
  - name: "Lab Guide"
    type: "docs"
    url: /
----

This creates:
- **Terminal tab**: Direct SSH access to lab-server
- **Lab Guide tab**: Documentation/instructions

[NOTE]
====
For UI variable syntax, see <<satellite-ui>> and <<template-ui>>.  
Use shell-style variables (no curly braces) in `ui-config.yml`.
====

== Step 4: Verify Network Configuration

Your VM uses the `default` network. Verify it is defined in `config/networks.yaml`:

.Check Network Configuration <<agnosticd-base>>
[source,bash]
----
cat config/networks.yaml
----

You should see:
.Default Network Definition <<agnosticd-base>>
[source,yaml]
----
---
# Default network exists by default, specify here always.
- name: default
----

This is correct for a single VM setup. The default network provides:
- Internet connectivity
- DNS resolution  
- SSH access from the platform
- Access to the lab interface

== Step 5: Configure Firewall Rules

For a basic lab server, minimal firewall configuration is required:

[source,bash]
----
cat config/firewall.yaml
----

Update it to:
[source,yaml]
----
---
# Allow outbound web traffic for package installation
egress:
  - ports:
      - protocol: TCP
        port: 443  # HTTPS
      - protocol: TCP
        port: 80   # HTTP

# Allow inbound SSH (typically handled automatically)
ingress:
  - ports:
      - protocol: TCP
        port: 22   # SSH
----

See <<agnosticd-base>> for firewall configuration details.

== Step 6: Validate Your Configuration

=== YAML Syntax Check

Validate that your YAML is syntactically correct:

[source,bash]
----
# Check each file for syntax errors
python3 -c "import yaml; yaml.safe_load(open('config/instances.yaml'))" && echo "instances.yaml: OK"
python3 -c "import yaml; yaml.safe_load(open('config/networks.yaml'))" && echo "networks.yaml: OK"  
python3 -c "import yaml; yaml.safe_load(open('config/firewall.yaml'))" && echo "firewall.yaml: OK"
python3 -c "import yaml; yaml.safe_load(open('ui-config.yml'))" && echo "ui-config.yml: OK"
----

=== Configuration Logic Check

Verify the relationships between files:

**Network References**:
[source,bash]
----
# Check that networks used in instances.yaml exist in networks.yaml
echo "Networks used by VMs:"
grep -A 5 "networks:" config/instances.yaml

echo "Networks defined:"
grep "name:" config/networks.yaml
----

**Resource Totals** (for planning):
[source,bash]
----
echo "Total memory allocation:"
grep "memory:" config/instances.yaml | awk '{sum += $2} END {print sum "G total"}'

echo "Total CPU cores:"
grep "cores:" config/instances.yaml | awk '{sum += $2} END {print sum " cores total"}'
----

== Step 7: Test Configuration

=== Create a Test Content File

Create a simple instruction file to test the setup:

[source,bash]
----
cat > content/modules/ROOT/pages/test-lab.adoc << 'EOF'
= Test Lab: Basic RHEL Commands

Welcome to your lab server! Let's verify everything is working.

== Step 1: Check System Information

Run this command to see system details:

[source,bash]
----
hostnamectl
----

== Step 2: Check Available Packages

List the packages we pre-installed:

[source,bash]
----
rpm -qa | grep -E "git|vim|tree|htop"
----

== Step 3: Test Network Connectivity

Verify internet access:

[source,bash]
----
curl -s https://httpbin.org/ip
----

If you see an IP address, your lab server is properly configured.
EOF
----

=== Update Site Configuration

Update `site.yml` to point to your test lab:

[source,yaml]
----
site:
  title: "My First Zero Touch Lab"
  url: https://demo.redhat.com/my-lab
  start_page: modules::test-lab.adoc  # Point to our test file

content:
  sources:
    - url: ./
      start_path: content

ui:
  bundle:
    url: https://github.com/rhpds/nookbag-bundle/releases/download/v0.0.5/nookbag-v0.0.5.zip
----

== Configuration Review Checklist

Before proceeding, verify you have completed the following:

**VM Configuration**:
- [ ] VM name changed from "host1" to "lab-server"
- [ ] Memory set to 4G and cores set to 2
- [ ] Useful packages included (git, vim, tree, htop)
- [ ] Connected to default network
- [ ] Tags added for organization and deployment

**UI Configuration**:
- [ ] Tab updated to point to lab-server terminal
- [ ] Tab name is descriptive (">_ lab-server")
- [ ] Documentation tab included

**Network & Security**:
- [ ] Default network exists in networks.yaml
- [ ] Firewall allows necessary traffic (HTTP/HTTPS outbound, SSH inbound)
- [ ] No unused network references

**Content**:
- [ ] Test content file created
- [ ] Site configuration points to test content
- [ ] Instructions are clear and testable

== Summary

You have successfully:

* **Created your first VM configuration** from scratch  
* **Updated the UI** to match your infrastructure  
* **Configured networking and security** appropriately  
* **Created test content** to validate your setup  
* **Learned the relationship** between configuration files  

== Troubleshooting

**Common Issues**:

**YAML Syntax Error**:
