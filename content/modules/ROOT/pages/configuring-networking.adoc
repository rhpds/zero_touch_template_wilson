= Configuring Networking

This guide explains how to configure custom networks for your lab environment by modifying the `config/networks.yaml` file.

== Overview

The networking configuration allows you to:

* Create custom networks for different tiers or purposes
* Implement network segmentation for security
* Control connectivity between instances
* Design complex network topologies

== Configuration File Structure

The `networks.yaml` file contains a list of network definitions:

[source,yaml]
----
---
- name: default
- name: custom-network
  cidr: "10.1.0.0/24"
  description: "Custom network for web tier"
----

== Default Network

The `default` network is automatically created and available to all instances. It provides basic connectivity and should always be included in your configuration:

[source,yaml]
----
---
- name: default
----

== Creating Custom Networks

=== Basic Network Configuration

To create a custom network, add it to the networks list:

[source,yaml]
----
---
- name: default
- name: web-network
  cidr: "10.1.0.0/24"
  description: "Network for web servers"
----

=== Network Configuration Parameters

[cols="1,1,3"]
|===
|Parameter |Required |Description

|`name`
|Yes
|Unique network identifier (alphanumeric and hyphens only)

|`cidr`
|No
|Network CIDR block (defaults to auto-assigned range)

|`description`
|No
|Human-readable description of the network purpose

|`dns`
|No
|Custom DNS configuration for the network

|`gateway`
|No
|Custom gateway IP address

|`dhcp`
|No
|DHCP configuration options
|===

== Network Topology Examples

=== Simple Multi-Tier Architecture

Create separate networks for different application tiers:

[source,yaml]
----
---
- name: default
- name: web-tier
  cidr: "10.1.0.0/24"
  description: "Web servers and load balancers"
- name: app-tier
  cidr: "10.2.0.0/24"
  description: "Application servers"
- name: data-tier
  cidr: "10.3.0.0/24"
  description: "Database servers and storage"
----

=== Development and Production Separation

Isolate different environments:

[source,yaml]
----
---
- name: default
- name: dev-network
  cidr: "10.10.0.0/24"
  description: "Development environment"
- name: staging-network
  cidr: "10.20.0.0/24"
  description: "Staging environment"
- name: prod-network
  cidr: "10.30.0.0/24"
  description: "Production environment"
----

=== Departmental Networks

Segment by organizational units:

[source,yaml]
----
---
- name: default
- name: hr-network
  cidr: "10.100.0.0/24"
  description: "Human Resources department"
- name: finance-network
  cidr: "10.200.0.0/24"
  description: "Finance department"
- name: it-network
  cidr: "10.300.0.0/24"
  description: "IT department"
----

== Advanced Network Configuration

=== DNS Subdomains

Labs can use the `.lab` subdomain for consistent FQDN resolution:

[source,yaml]
----
---
- name: default
- name: lab-network
  cidr: "10.4.0.0/24"
  description: "Lab network with .lab subdomain support"
  dns:
    servers:
      - "8.8.8.8"
      - "8.8.4.4"
    search_domains:
      - "lab.local"
      - "lab"
----

With this configuration, instances can communicate using hostnames like:
- `satellite.lab`
- `node01.lab` 
- `control.lab`

=== Custom DNS Configuration

Configure custom DNS servers for a network:

[source,yaml]
----
---
- name: default
- name: custom-dns-network
  cidr: "10.4.0.0/24"
  description: "Network with custom DNS"
  dns:
    servers:
      - "8.8.8.8"
      - "8.8.4.4"
    search_domains:
      - "lab.local"
      - "example.com"
----

=== Custom Gateway Configuration

Specify a custom gateway for the network:

[source,yaml]
----
---
- name: default
- name: custom-gateway-network
  cidr: "10.5.0.0/24"
  description: "Network with custom gateway"
  gateway: "10.5.0.1"
----

=== DHCP Configuration

Configure DHCP options for the network:

[source,yaml]
----
---
- name: default
- name: dhcp-network
  cidr: "10.6.0.0/24"
  description: "Network with custom DHCP"
  dhcp:
    pool_start: "10.6.0.10"
    pool_end: "10.6.0.200"
    lease_time: "24h"
    options:
      - name: "domain-name"
        value: "lab.local"
      - name: "ntp-servers"
        value: "10.6.0.1"
----

== Connecting Instances to Networks

=== Single Network Connection

Connect an instance to one network (specified in `instances.yaml`):

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 1
    image_size: "20G"
    networks:
      - web-tier
----

=== Multiple Network Connections

Connect an instance to multiple networks:

[source,yaml]
----
virtualmachines:
  - name: "app-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "30G"
    networks:
      - default        # Management network
      - web-tier       # Frontend network
      - app-tier       # Backend network
----

=== Network Interface Configuration

For advanced scenarios, specify interface details:

[source,yaml]
----
virtualmachines:
  - name: "gateway-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 2
    image_size: "20G"
    network_interfaces:
      - network: default
        ip: "10.0.0.10"
        primary: true
      - network: web-tier
        ip: "10.1.0.1"
      - network: app-tier
        ip: "10.2.0.1"
----

== Network Security Considerations

=== Network Isolation

Use separate networks to isolate different components:

[source,yaml]
----
---
- name: default
- name: dmz
  cidr: "10.10.0.0/24"
  description: "DMZ for public-facing services"
- name: internal
  cidr: "10.20.0.0/24"
  description: "Internal services network"
- name: mgmt
  cidr: "10.30.0.0/24"
  description: "Management network"
----

=== Access Control

Combine with firewall rules to control inter-network communication:

[source,yaml]
----
---
- name: default
- name: trusted
  cidr: "10.100.0.0/24"
  description: "Trusted internal network"
- name: untrusted
  cidr: "10.200.0.0/24"
  description: "Untrusted guest network"
----

== Complete Example

Here's a comprehensive network configuration for a lab environment:

[source,yaml]
----
---
# Default network (always required)
- name: default

# Web tier network
- name: web-tier
  cidr: "10.1.0.0/24"
  description: "Frontend web servers and load balancers"
  dns:
    servers:
      - "8.8.8.8"
      - "1.1.1.1"
    search_domains:
      - "web.lab.local"

# Application tier network
- name: app-tier
  cidr: "10.2.0.0/24"
  description: "Application servers and middleware"
  dns:
    search_domains:
      - "app.lab.local"

# Database tier network
- name: db-tier
  cidr: "10.3.0.0/24"
  description: "Database servers and storage"
  dns:
    search_domains:
      - "db.lab.local"

# Management network
- name: mgmt
  cidr: "10.100.0.0/24"
  description: "Management and monitoring services"
  dhcp:
    pool_start: "10.100.0.50"
    pool_end: "10.100.0.200"

# Development network
- name: dev
  cidr: "10.200.0.0/24"
  description: "Development and testing environment"

# Container network
- name: container-net
  cidr: "10.50.0.0/16"
  description: "Dedicated network for container workloads"
----

== Best Practices

=== Network Design

* Plan your network topology before implementation
* Use meaningful, descriptive network names
* Reserve address space for future expansion
* Document network purposes and access patterns

=== CIDR Planning

* Use private IP address ranges (RFC 1918)
* Avoid overlapping CIDR blocks
* Plan for network growth and segmentation
* Consider integration with existing networks

=== Security

* Implement network segmentation based on trust levels
* Use smallest practical CIDR blocks
* Combine with firewall rules for access control
* Monitor inter-network traffic

=== Performance

* Consider network latency between tiers
* Plan for bandwidth requirements
* Minimize unnecessary network hops
* Use appropriate network sizes

== Troubleshooting

=== Common Issues

. **CIDR conflicts**: Ensure CIDR blocks don't overlap
. **Invalid network references**: Verify network names match between files
. **DNS resolution**: Check DNS configuration and connectivity
. **Routing problems**: Verify gateway and routing configuration

=== Validation Steps

. Validate YAML syntax: `yamllint config/networks.yaml`
. Check for CIDR block conflicts
. Verify network references in `instances.yaml`
. Test connectivity after provisioning

=== Debugging Network Issues

. Check instance network configuration
. Verify routing tables
. Test DNS resolution
. Monitor network traffic and logs

== Integration with Other Components

=== Firewall Rules

Network configuration works with firewall rules defined in `firewall.yaml`:

* Define allowed traffic between networks
* Control ingress and egress traffic
* Implement micro-segmentation

=== Load Balancing

Consider load balancer placement across networks:

* Frontend load balancers in web-tier
* Internal load balancers in app-tier
* Database load balancing in db-tier

=== Monitoring

Plan for monitoring and observability:

* Place monitoring tools in management network
* Configure network visibility tools
* Implement network performance monitoring

== Related Documentation

* xref:adding-instances.adoc[Adding Instances and Containers]
* xref:configuring-firewall.adoc[Configuring Firewall Rules]
* xref:creating-content.adoc[Creating Lab Content and UI Configuration]
* xref:advanced-lab-features.adoc[Advanced Lab Features and Special Cases]
* xref:template-customization-guide.adoc[Template Customization Guide]
