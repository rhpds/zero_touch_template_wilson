= Adding Instances and Containers

This guide explains how to add virtual machines and containers to your lab environment by modifying the `config/instances.yaml` file.

== Configuration File Structure

The `instances.yaml` file contains two main sections:

* `virtualmachines`: Defines virtual machine instances
* `containers`: Defines container instances

[source,yaml]
----
---
containers: []
virtualmachines:
  - name: "example-vm"
    # VM configuration here
----

== Adding Virtual Machines

=== Basic Virtual Machine Configuration

To add a new virtual machine, append it to the `virtualmachines` list:

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 2
    image_size: "20G"
    networks:
      - default
----

=== VM Configuration Parameters

[cols="1,1,3"]
|===
|Parameter |Required |Description

|`name`
|Yes
|Unique identifier for the VM (alphanumeric and hyphens only)

|`image`
|Yes
|Base image to use (e.g., `rhel-9.6`, `ubuntu-22.04`, `centos-9`)

|`memory`
|Yes
|RAM allocation (e.g., `1G`, `2G`, `4G`, `8G`)

|`cores`
|Yes
|Number of CPU cores to assign

|`image_size`
|Yes
|Disk size allocation (e.g., `20G`, `40G`, `100G`)

|`networks`
|No
|List of networks to connect (defaults to `default`)

|`tags`
|No
|Key-value pairs for metadata and grouping

|`services`
|No
|Service definitions for port exposure

|`routes`
|No
|Route definitions for external access
|===

=== Advanced VM Configuration

==== Boot Configuration

===== EFI Bootloader

Some images require EFI bootloader instead of BIOS (especially Business Unit provided images):

[source,yaml]
----
virtualmachines:
  - name: "satellite"
    image: "satellite-server-rhdp-1-6-17-06-27-25-2"
    memory: "8G"
    cores: 4
    image_size: "100G"
    bootloader: efi
    networks:
      - default
----

===== SCSI Disk Type

Some images (Windows or specific Business Unit images) require SCSI disks instead of VirtIO:

[source,yaml]
----
virtualmachines:
  - name: "control"
    image: "aap-25-c-20250611"
    memory: "4G"
    cores: 2
    image_size: "30G"
    disk_type: "scsi"
    networks:
      - default
----

==== Cloud-Init Configuration

Configure users, networking, and run commands using cloud-init:

[source,yaml]
----
virtualmachines:
  - name: "rhel-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    networks:
      - default
    userdata: |
      #cloud-config
      user: rhel
      password: {{ common_password }}
      chpasswd: { expire: False }
      fqdn: satellite.lab
      hostname: satellite
      prefer_fqdn_over_hostname: true
      manage_etc_hosts: true
      runcmd:
        - sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/" /etc/ssh/sshd_config
        - systemctl reload sshd
----

==== Package Installation

Install specific packages per VM instance:

[source,yaml]
----
virtualmachines:
  - name: "rhel-workstation"
    image: "rhel-9.5"
    memory: "4G"
    cores: 2
    image_size: "40G"
    packages:
      - git
      - cockpit
      - podman
      - vim
    networks:
      - default
----

==== Special Instance Configurations

===== Isolated Nodes

For instances that should not be managed by automation (pre-built images):

[source,yaml]
----
virtualmachines:
  - name: "isolated-server"
    image: "prebuilt-app-server"
    memory: "4G"
    cores: 2
    image_size: "40G"
    tags:
      - key: "AnsibleGroup"
        value: "isolated"
    networks:
      - default
----

===== Disable Satellite Registration

For labs that don't require Satellite registration (like Satellite labs themselves):

[source,yaml]
----
virtualmachines:
  - name: "satellite-server"
    image: "satellite-server-rhdp-2-6-17-06-23-25"
    memory: "8G"
    cores: 4
    image_size: "100G"
    bootloader: efi
    register_satellite: false
    networks:
      - default
----

==== Adding Tags

Tags are useful for Ansible automation and resource management:

[source,yaml]
----
virtualmachines:
  - name: "database-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "50G"
    tags:
      - key: "AnsibleGroup"
        value: "databases"
      - key: "Environment"
        value: "lab"
      - key: "Role"
        value: "mysql"
    networks:
      - default
----

==== Exposing Services

To expose services running on your VM:

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 2
    image_size: "20G"
    networks:
      - default
    services:
      - name: apache
        ports:
          - port: 80
            protocol: TCP
            targetPort: 80
            name: http
          - port: 443
            protocol: TCP
            targetPort: 443
            name: https
----

==== Adding Routes for External Access

Routes provide external URLs to access services:

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 2
    image_size: "20G"
    networks:
      - default
    services:
      - name: apache
        ports:
          - port: 80
            protocol: TCP
            targetPort: 80
            name: http
    routes:
      - name: web-app
        host: webapp
        service: apache
        targetPort: 80
        tls: true
        tls_termination: Edge
----

== Adding Containers

Container instances are defined in the `containers` section:

[source,yaml]
----
containers:
  - name: "redis-cache"
    image: "redis:7-alpine"
    ports:
      - containerPort: 6379
        protocol: TCP
    env:
      - name: REDIS_PASSWORD
        value: "lab-password"
----

=== Container Configuration Parameters

[cols="1,1,3"]
|===
|Parameter |Required |Description

|`name`
|Yes
|Unique identifier for the container

|`image`
|Yes
|Container image (Docker Hub or registry URL)

|`ports`
|No
|List of ports to expose

|`env`
|No
|Environment variables

|`volumes`
|No
|Volume mounts for persistent storage

|`resources`
|No
|CPU and memory limits/requests
|===

=== Advanced Container Configuration

==== Real-World Container Examples

===== Gitea Git Server

Complete Gitea setup with initialization commands:

[source,yaml]
----
containers:
  - name: gitea
    image: quay.io/agonzalezrh/gitea:1.16.8-rootless
    ports:
      - name: gitea
        containerPort: 3000
        protocol: TCP
    environment:
      GITEA__DEFAULT__RUN_MODE: dev
      GITEA__database__DB_TYPE: sqlite3
      GITEA__database__PATH: /data/gitea/gitea.db
      GITEA__picture__DISABLE_GRAVATAR: "true"
      GITEA__repository__DEFAULT_PRIVATE: "false"
      GITEA__repository__DEFAULT_PUSH_CREATE_PRIVATE: "false"
      GITEA__repository__ENABLE_PUSH_CREATE_ORG: "true"
      GITEA__repository__ENABLE_PUSH_CREATE_USER: "true"
      GITEA__repository__ONLY_ALLOW_PUSH_IF_GITEA_ENVIRONMENT_SET: "false"
      GITEA__security__INSTALL_LOCK: "true"
      GITEA__server__SSH_DOMAIN: http://gitea
      GITEA__service__DISABLE_REGISTRATION: "true"
      GITEA__service__REQUIRE_SIGNIN_VIEW: "false"
      GITEA__webhook__ALLOWED_HOST_LIST: '*'
    volumeMounts:
      - name: gitea-varlib
        mountPath: /var/lib/gitea/
      - name: gitea-data
        mountPath: /data/
      - name: gitea-etc
        mountPath: /etc/gitea
    volumes:
      - name: gitea-data
        emptyDir: {}
      - name: gitea-etc
        emptyDir: {}
      - name: gitea-varlib
        emptyDir: {}
    commands:
      - gitea admin user create --admin --username gitea --password gitea --email dummy@dummy.com --must-change-password=false
      - curl -X POST -H "accept: application/json" -H "Content-Type: application/json" -u 'gitea:gitea' -d '{"username": "student", "full_name": "student", "description": "student"}' http://localhost:3000/api/v1/orgs
      - curl -X POST -H "accept: application/json" -H "Content-Type: application/json" -u 'gitea:gitea' -d '{"clone_addr": "https://github.com/ansible-tmm/aap25-roadshow", "repo_name": "aap25-roadshow-content", "owner": "student", "uid": 2, "private": false}' http://localhost:3000/api/v1/repos/migrate
    memory: 2Gi
    services:
      - name: gitea
        ports:
          - port: 3000
            protocol: TCP
            targetPort: 3000
            name: gitea
    routes:
      - name: gitea
        host: gitea
        service: gitea
        targetPort: 3000
        tls: true
        tls_termination: Edge
----

===== Kafka Message Broker

[source,yaml]
----
containers:
  - name: broker
    image: confluentinc/cp-kafka:7.0.1
    ports:
      - name: broker
        containerPort: 9092
        protocol: TCP
    environment:
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: "1"
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: "1"
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: "1"
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:9092,PLAINTEXT_INTERNAL://broker:29092
      KAFKA_BROKER_ID: "1"
    volumeMounts:
      - name: kafka-varlog
        mountPath: /var/log/kafka/
    volumes:
      - name: kafka-varlog
        emptyDir: {}
    memory: 4Gi
    services:
      - name: broker
        ports:
          - port: 9092
            protocol: TCP
            targetPort: 9092
            name: broker
----

===== PostgreSQL Database

[source,yaml]
----
containers:
  - name: "postgres-db"
    image: "postgres:15"
    ports:
      - containerPort: 5432
        protocol: TCP
    env:
      - name: POSTGRES_DB
        value: "labdb"
      - name: POSTGRES_USER
        value: "student"
      - name: POSTGRES_PASSWORD
        value: "lab-password"
    volumes:
      - name: postgres-data
        mountPath: /var/lib/postgresql/data
        size: 10Gi
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"
      limits:
        cpu: "500m"
        memory: "1Gi"
----

== Complete Example

Here's a comprehensive example with multiple VMs and containers:

[source,yaml]
----
---
containers:
  - name: "redis-cache"
    image: "redis:7-alpine"
    ports:
      - containerPort: 6379
        protocol: TCP
    env:
      - name: REDIS_PASSWORD
        value: "lab-password"

virtualmachines:
  - name: "control-node"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    tags:
      - key: "AnsibleGroup"
        value: "controllers"
    networks:
      - default
    services:
      - name: vscode
        ports:
          - port: 3000
            protocol: TCP
            targetPort: 3000
            name: vscode
    routes:
      - name: vscode
        host: vscode
        service: vscode
        targetPort: 3000
        tls: true
        tls_termination: Edge

  - name: "web-server-01"
    image: "rhel-9.6"
    memory: "2G"
    cores: 1
    image_size: "20G"
    tags:
      - key: "AnsibleGroup"
        value: "webservers"
    networks:
      - default
      - web-network

  - name: "web-server-02"
    image: "rhel-9.6"
    memory: "2G"
    cores: 1
    image_size: "20G"
    tags:
      - key: "AnsibleGroup"
        value: "webservers"
    networks:
      - default
      - web-network

  - name: "database-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "50G"
    tags:
      - key: "AnsibleGroup"
        value: "databases"
    networks:
      - default
      - db-network
----

== Best Practices

=== Naming Conventions

* Use descriptive, lowercase names with hyphens
* Include role or function in the name (e.g., `web-server`, `db-primary`)
* Avoid special characters and spaces

=== Resource Allocation

* Start with minimal resources and scale up as needed
* Consider the total resource capacity of your environment
* Balance resource allocation across instances

=== Network Design

* Use `default` network for simple connectivity
* Create custom networks for complex topologies
* Plan network segmentation for security

=== Security Considerations

* Use strong passwords in environment variables
* Limit exposed ports to necessary services only
* Consider network isolation between different tiers

== Troubleshooting

=== Common Issues

. **Invalid YAML syntax**: Use a YAML validator to check formatting
. **Resource constraints**: Ensure total allocated resources don't exceed cluster capacity
. **Name conflicts**: Each instance name must be unique
. **Network references**: Ensure referenced networks are defined in `networks.yaml`

=== Validation Steps

. Check YAML syntax: `yamllint config/instances.yaml`
. Validate total resource allocation
. Verify network references
. Test provisioning in a development environment

== Related Documentation

* xref:configuring-networking.adoc[Configuring Networking]
* xref:configuring-firewall.adoc[Configuring Firewall Rules]
* xref:creating-content.adoc[Creating Lab Content and UI Configuration]
* xref:advanced-lab-features.adoc[Advanced Lab Features and Special Cases]
* xref:template-customization-guide.adoc[Template Customization Guide]
