= Networking Basics
:estimated-time: 15-20 minutes

== Learning Outcomes

Upon completion, you will understand:

* Network topology design with proper CIDR allocation and segmentation
* Multi-network environment configuration for complex lab scenarios
* Network isolation implementation between different lab components
* Network connectivity troubleshooting and common networking issue resolution

== Overview

This guide covers essential networking concepts and configurations for Zero Touch lab environments. You'll learn to design and implement network topologies that support your lab requirements.

== Configuration File Structure

The `config/networks.yaml` file defines your lab's network topology:

.Basic Network Configuration <<agnosticd-base>>
[source,yaml]
----
---
# Default network exists by default, specify here always.
- name: default

- name: "lab-network"
  cidr: "10.1.0.0/24"
  description: "Main lab network"

- name: "dmz-network"  
  cidr: "10.2.0.0/24"
  description: "DMZ for public services"
----

== Default Network

Every lab automatically includes a `default` network:
* Provides internet access for VMs
* Uses NAT for outbound connectivity
* No additional configuration required

== Creating Custom Networks

=== Basic Network Configuration

[source,yaml]
----
---
- name: "backend-db"
  cidr: "192.168.10.0/24"
  description: "Database tier network"
  
- name: "frontend-web"
  cidr: "192.168.20.0/24" 
  description: "Web server network"
----

=== Network Parameters

[cols="1,1,3"]
|===
|Parameter |Required |Description

|`name`
| Yes
|Unique network identifier (DNS-safe)

|`cidr` 
| Yes
|Network range in CIDR notation

|`description`
|No
|Human-readable network description

|`mtu`
|No
|Maximum Transmission Unit (default: 1500)
|===

== Common Network Patterns

=== Development Environment

[source,yaml]
----
---
- name: "dev-network"
  cidr: "10.100.0.0/24"
  description: "Development environment"
  
- name: "test-network"
  cidr: "10.200.0.0/24" 
  description: "Testing environment"
----

=== Multi-Tier Architecture

[source,yaml]
----
---
- name: "web-tier"
  cidr: "10.10.0.0/24"
  description: "Web servers and load balancers"
  
- name: "app-tier"
  cidr: "10.20.0.0/24"
  description: "Application servers"
  
- name: "data-tier"
  cidr: "10.30.0.0/24"
  description: "Database and storage"
----

== Connecting VMs to Networks

In your `config/instances.yaml`, specify networks for each VM:

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    networks:
      - default        # Internet access
      - web-tier      # Custom network
    
  - name: "database"
    image: "rhel-9.6" 
    networks:
      - data-tier     # Isolated network
----

== Best Practices

=== CIDR Planning
* **Use private ranges**: 10.x.x.x, 172.16-31.x.x, 192.168.x.x
* **Plan for growth**: Leave room for additional subnets
* **Avoid conflicts**: Don't overlap with existing networks

=== Network Design
* **Default + Custom**: Always include default for internet access
* **Logical separation**: Group related services on same network
* **Security zones**: Separate tiers with different trust levels

== Testing Your Networks

After deploying, verify network configuration:

[source,bash]
----
# On each VM, check interfaces
ip addr show

# Test connectivity between VMs on same network
ping <other-vm-ip>

# Verify internet access via default network
ping google.com
----

== Troubleshooting

**VMs can't communicate?**
→ Check they're on the same custom network

**No internet access?** 
→ Ensure VMs include `default` network

**IP conflicts?**
→ Verify CIDR ranges don't overlap

== Network Security: Firewall vs Network Policies

**Understanding the Two Security Layers:**

Zero Touch deployments use **two different security mechanisms** that work together:

=== Firewall Rules (`firewall.yaml`)

**Purpose**: Control **external** network access (internet, outside OpenShift)
**Scope**: **Ingress** (traffic coming into lab) and **Egress** (traffic going out)
**Configuration**: Template-level in `config/firewall.yaml`

[source,yaml]
----
# firewall.yaml - Controls external access
egress:
  - ports:
      - protocol: TCP
        port: 443  # HTTPS to internet
      - protocol: TCP  
        port: 80   # HTTP to internet
ingress:
  - ports:
      - protocol: TCP
        port: 8080  # External access to apps
----

=== Network Policies (AgnosticD)

**Purpose**: Control **internal** communication between pods/VMs within OpenShift
**Scope**: **Container-to-VM** SSH access, **pod-to-pod** communication
**Configuration**: Deployment-level variables (not in template files)

[source,yaml]
----
# sample_vars.yml - Controls internal OpenShift communication
zero_touch_ingress_lockdown_rules:
  - from:
      - podSelector:
          matchLabels:
            app.kubernetes.io/name: vscode  # Container SSH to VMs
    ports:
      - protocol: TCP
        port: 22
----

=== Key Differences

[cols="2,3,3"]
|===
|Aspect |Firewall Rules |Network Policies

|**Controls**
|External internet access
|Internal pod/VM communication

|**Configured In**
|Template `firewall.yaml` file
|Deployment variables

|**Common Issues**
|"Connection timeout to external API"
|"Container SSH to VM fails"

|**Troubleshooting**
|Check `firewall.yaml` port rules
|Check `zero_touch_ingress_lockdown_rules`

|**Affects**
|Internet access, external APIs
|SSH, internal service communication
|===

**Important**: Both layers work together. A container needs:
1. **Network policy permission** to SSH to VM (internal)  
2. **Firewall rule** for any external internet access

== Related Documentation

* xref:vm-basics.adoc[Adding Instances] - Connect VMs to networks
* xref:enterprise-lab-patterns.adoc[Enterprise Lab Patterns] - Complex networking topologies - Complex topologies
* xref:firewall-basics.adoc[Configuring Firewall Rules] - External network security
* xref:network-policy-configuration.adoc[Network Policy Configuration] - Internal container SSH security

[bibliography]
== References

* [[[agnosticd-base]]] Red Hat GPTE Team. AgnosticD Zero Touch Base RHEL Configuration. 
  `/home/wilson/Projects/agnosticd/ansible/configs/zero-touch-base-rhel/default_vars_openshift_cnv.yaml`. 2024.

* [[[template-instances]]] Red Hat GPTE Team. Zero Touch Template Instance Configuration. 
  `/home/wilson/Projects/zero_touch_template_wilson/config/instances.yaml`. 2024.
