= OpenShift CNV Platform Features

== Learning Outcomes

Upon completion, you will understand:

* Advanced virtualization feature configuration including UEFI, SecureBoot, and hugepages
* VM performance optimization with proper disk bus types and interface models
* Enterprise security pattern implementation with TPM and isolation configurations
* Sophisticated networking design with multiple interfaces and advanced CNV features
* Platform-specific troubleshooting and CNV capability leverage

== Overview

The Zero Touch platform runs on OpenShift Container Native Virtualization (CNV), providing advanced virtualization capabilities that go far beyond basic VM hosting. Understanding these platform features enables you to create sophisticated, enterprise-grade lab environments.

== Advanced VM Configuration

=== Boot Configuration Options

CNV supports multiple boot configurations for different VM requirements:

[source,yaml]
----
virtualmachines:
  - name: "rhel-workstation"
    # Boot configuration options
    bootloader: efi        # Options: 'bios', 'efi', 'uefi'
    machine_type: "pc-q35-rhel9.2.0"  # QEMU machine type
    
    # UEFI with SecureBoot (enterprise security)
    bootloader: uefi
    secureboot: true       # Requires UEFI mode
----

**Boot Options Explained**:
- **`bios`**: Traditional BIOS boot (default, maximum compatibility)
- **`efi`/`uefi`**: Modern UEFI boot (required for SecureBoot, Windows 11)
- **`secureboot`**: Enhanced security for enterprise environments

=== Advanced Memory Management

CNV provides sophisticated memory management capabilities:

[source,yaml]
----
virtualmachines:
  - name: "high-performance-vm"
    memory: "16G"
    cores: 8
    
    # Advanced memory features (configured by platform)
    hugepages: true        # 1GiB hugepages for performance
    memory_overcommit: false  # Guarantee memory allocation
----

**Performance Benefits**:
- **Hugepages**: Reduces memory management overhead for large VMs
- **Memory Guarantees**: Ensures consistent performance under load
- **Host-Passthrough CPU**: Maximum CPU performance for labs

=== Storage and Disk Configuration

Configure advanced storage options for your VMs:

[source,yaml]
----
virtualmachines:
  - name: "database-server"
    image: "rhel-9.6"
    image_size: "100G"
    
    # Disk interface configuration
    disk_type: "virtio"    # Options: 'virtio', 'scsi', 'sata'
    
    # Additional disks
    additional_disks:
      - name: "data-disk"
        size: "500G"
        bus: "scsi"          # High-performance disk interface
      - name: "logs-disk"  
        size: "100G"
        bus: "virtio"        # Standard performance
----

** Storage Features**:
- **Multiple Bus Types**: virtio (performance), SCSI (compatibility), SATA (legacy)
- **Dynamic Provisioning**: Kubernetes-native storage management
- **Block Storage**: Direct block device access for databases
- **Volume Expansion**: Resize storage without VM downtime

==  Advanced Networking Capabilities

=== Network Interface Models

Configure network interfaces for different performance requirements:

[source,yaml]
----
virtualmachines:
  - name: "network-intensive-vm"
    # Network interface configuration
    interface_model: "virtio"  # Options: 'virtio', 'e1000e', 'rtl8139'
    
    # Multiple networks with different models
    networks:
      - name: "management"
        interface_model: "e1000e"   # Better Windows compatibility
      - name: "data"  
        interface_model: "virtio"   # Higher performance
----

** Interface Types**:
- **`virtio`**: High-performance virtualized interface (default)
- **`e1000e`**: Intel emulation (Windows compatibility)
- **`rtl8139`**: Legacy compatibility

=== Advanced Network Attachment

CNV uses Multus for multiple network interfaces:

[source,yaml]
----
# In networks.yaml - CNV creates NetworkAttachmentDefinitions
---
- name: "lab-network"
  cidr: "10.4.0.0/24"
  mtu: 9000              # Jumbo frames support
  dns:
    servers: ["8.8.8.8"]
    
- name: "storage-network" 
  cidr: "10.5.0.0/24"
  mtu: 1500
  vlan: 100              # VLAN tagging support
----

**ðŸ”— CNV Network Types**:
- **Pod Network**: Default Kubernetes networking (masquerade mode)
- **Bridge Network**: Direct L2 access to external networks
- **Multus Networks**: Multiple interfaces per VM
- **VLAN Support**: Network isolation and segmentation

=== MAC Address Management

Control MAC addresses for network consistency:

[source,yaml]
----
virtualmachines:
  - name: "dhcp-server"
    networks:
      - default
      - lab-network
    
    # Fixed MAC addresses per network
    fixed_macs:
      default: "2c:c2:60:aa:bb:cc"
      lab-network: "2c:c2:60:dd:ee:ff"
----

**Benefits**:
- **DHCP Reservations**: Consistent IP assignments
- **Network Monitoring**: Predictable network identifiers
- **Compliance**: Meet security audit requirements

== Container Integration

=== Advanced Container Configuration

CNV deployments can include sophisticated container workloads:

[source,yaml]
----
containers:
  - name: "monitoring-stack"
    image: "quay.io/prometheus/prometheus:latest"
    
    # Resource management
    cpu: "2"               # 2 CPU cores
    memory: "4G"           # 4GB memory
    
    # Advanced features
    lifecycle:
      postStart:
        exec:
          command: ["/bin/sh", "-c", "echo 'Container started'"]
      preStop:
        exec:
          command: ["/bin/sh", "-c", "/cleanup.sh"]
    
    # Volume configuration
    volumes:
      - name: "data"
        emptyDir: {}
      - name: "config"
        configMap:
          name: "prometheus-config"
    
    volumeMounts:
      - name: "data"
        mountPath: "/prometheus/data"
      - name: "config"
        mountPath: "/etc/prometheus"
----

**Container Features**:
- **Resource Guarantees**: CPU and memory requests/limits
- **Lifecycle Management**: Startup and shutdown hooks
- **Volume Management**: Persistent and ephemeral storage
- **Environment Variables**: Dynamic configuration

== VM Lifecycle Management

=== Run Strategies

CNV provides sophisticated VM lifecycle control:

[source,yaml]
----
# Platform automatically manages these strategies
virtualmachines:
  - name: "always-on-service"
    run_strategy: "Always"      # VM restarts automatically
    
  - name: "on-demand-vm"
    run_strategy: "Manual"      # Manual start/stop only
    
  - name: "stopped-template"  
    run_strategy: "Halted"      # VM template (not running)
----

**Run Strategy Options**:
- **`Always`**: VM automatically restarts if it stops
- **`Manual`**: Explicit start/stop control
- **`Halted`**: VM definition exists but not running

=== VM Control Operations

The platform supports advanced VM operations:

```bash
# VM lifecycle commands (executed by platform)
oc patch virtualmachine/myvm --type merge -p '{"spec":{"running":true}}'   # Start VM
oc patch virtualmachine/myvm --type merge -p '{"spec":{"running":false}}'  # Stop VM
oc get vmi                                                                  # Show running instances
oc get vm -o wide                                                          # Show VM status
```

**Management Features**:
- **Start/Stop Control**: Individual VM lifecycle management
- **Status Monitoring**: Real-time VM state reporting  
- **Bulk Operations**: Manage multiple VMs simultaneously
- **Resource Monitoring**: CPU, memory, network, storage metrics

== Cloud-Init Integration

=== Advanced VM Initialization

CNV provides sophisticated cloud-init capabilities:

[source,yaml]
----
virtualmachines:
  - name: "auto-configured-vm"
    image: "rhel-9.6"
    
    # Advanced cloud-init configuration
    userdata: |
      #cloud-config
      hostname: lab-server
      fqdn: lab-server.lab.local
      
      # User management
      users:
        - name: labuser
          sudo: ALL=(ALL) NOPASSWD:ALL
          lock_passwd: false
          passwd: "{{ common_password | password_hash('sha512') }}"
          
      # Package management
      package_update: true
      package_upgrade: false
      packages:
        - container-tools
        - git
        - vim
        
      # Service configuration
      runcmd:
        - systemctl enable --now cockpit.socket
        - firewall-cmd --permanent --add-service=cockpit
        - firewall-cmd --reload
        
      # File creation
      write_files:
        - path: /etc/lab-config.yaml
          content: |
            lab_name: "{{ lab_name }}"
            guid: "{{ guid }}"
            domain: "{{ domain }}"
----

**Cloud-Init Features**:
- **User Management**: Automated user creation and SSH key deployment
- **Package Installation**: Automated software installation
- **Service Configuration**: Automatic service startup and firewall rules
- **File Management**: Template file creation with variables
- **Network Configuration**: Static IP, DNS, routing configuration

== Security Features

=== Enterprise Security Integration

CNV provides enterprise-grade security capabilities:

**ðŸ›¡ Security Features**:
- **SecureBoot**: UEFI SecureBoot for trusted computing
- **TPM Emulation**: Hardware security module simulation
- **Network Policies**: Kubernetes-native network isolation
- **RBAC Integration**: Role-based access control
- **Audit Logging**: Comprehensive security audit trails

=== Compliance and Governance

** Compliance Features**:
- **Resource Quotas**: Limit resource consumption per lab
- **Network Isolation**: Complete network separation between labs
- **Access Control**: Fine-grained permissions management  
- **Monitoring Integration**: Integration with enterprise monitoring

== Performance Optimization

=== Resource Management

CNV provides advanced resource optimization:

** Performance Features**:
- **CPU Pinning**: Dedicate CPU cores to VMs
- **NUMA Awareness**: Optimize memory access patterns
- **SR-IOV Support**: Direct hardware access for networking
- **GPU Passthrough**: Direct GPU access for VMs

=== Monitoring and Metrics

** Observability**:
- **VM Metrics**: CPU, memory, disk, network monitoring
- **Platform Metrics**: CNV operator and infrastructure metrics
- **Custom Metrics**: Application-specific monitoring
- **Alerting Integration**: Prometheus and AlertManager integration

== Development and Testing

=== Lab Environment Features

**Development Capabilities**:
- **Snapshot Support**: VM state snapshots for testing
- **Clone Operations**: Rapid VM duplication
- **Template Management**: VM templates for consistency
- **Migration Support**: Live VM migration between nodes

== Platform Integration

=== Kubernetes-Native Features

CNV integrates deeply with Kubernetes:

**Integration Points**:
- **Custom Resources**: VirtualMachine, DataVolume, NetworkAttachmentDefinition
- **Operators**: Automated lifecycle management
- **Service Discovery**: Kubernetes-native service networking
- **Storage Integration**: CSI driver support for enterprise storage

---

**Key Takeaway**: OpenShift CNV provides enterprise-grade virtualization with Kubernetes-native management, enabling sophisticated lab environments that combine VMs, containers, and advanced networking in a single platform.

Understanding these capabilities allows you to design labs that leverage the full power of the Zero Touch platform, creating professional learning experiences that match real-world enterprise environments.

[bibliography]
== References

* [[[roadshow-instances]]] Red Hat Ansible Team. AAP 2.5 Roadshow Lab Instance Configuration. 
  `/home/wilson/Projects/showroom_git/zt-ans-bu-roadshow01/config/instances.yaml`. 2024.

* [[[agnosticd-base]]] Red Hat GPTE Team. AgnosticD Zero Touch Base RHEL Configuration. 
  `/home/wilson/Projects/agnosticd/ansible/configs/zero-touch-base-rhel/default_vars_openshift_cnv.yaml`. 2024.

* [[[template-instances]]] Red Hat GPTE Team. Zero Touch Template Instance Configuration. 
  `/home/wilson/Projects/zero_touch_template_wilson/config/instances.yaml`. 2024.
