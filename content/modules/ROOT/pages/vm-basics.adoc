= VM Configuration Basics
:estimated-time: 15-20 minutes

== Learning Outcomes

Upon completion, you will understand:

* Basic VM configuration patterns and resource allocation
* Cloud-init configuration for VM initialization and user management
* Essential VM parameters including memory, CPU, and storage settings
* VM networking and security configuration
* VM configuration validation and troubleshooting

== Overview

This guide covers essential VM setup and configuration by modifying the `config/instances.yaml` file. You'll learn to deploy reliable, properly configured virtual machines for lab environments.

== Configuration File Structure

[%collapsible]
====
The `instances.yaml` file defines your VMs and containers:

.Basic Configuration Structure <<template-instances>>
[source,yaml]
----
---
virtualmachines:
  - name: "lab-server"
    image: "rhel-9.6"
    cores: 2
    memory: "4G"
    
containers:
  - name: "web-app"
    image: "nginx:latest"
----

====

== Basic Virtual Machine Configuration

[%collapsible]
====
=== Essential VM Parameters

.Essential VM Configuration <<template-instances>>
[source,yaml]
----
virtualmachines:
  - name: "web-server"           # Unique VM identifier
    image: "rhel-9.6"           # Base OS image
    cores: 2                    # CPU cores
    memory: "4G"                # RAM allocation
    image_size: "50G"           # Disk size
----

=== VM Configuration Parameters

[cols="1,1,3"]
|===
|Parameter |Required |Description

|`name`
| Yes
|Unique VM identifier (DNS-safe)

|`image`  
| Yes
|Operating system image name

|`cores`
|No
|CPU cores (default: 1)

|`memory`
|No
|RAM in GB format like "4G" (default: "2G")

|`image_size`
|No
|Root disk size (default: "20G")

|`networks`
|No
|List of networks to connect (default: ["default"])

|`userdata`
|No
|Cloud-init configuration for custom setup commands

|`packages`
|No
|List of RPM packages to install automatically
|===

== Running Commands in VMs

[IMPORTANT]
====
**VMs do NOT support the `commands` field** - that's only for containers!

Use `userdata` with cloud-init syntax instead.
====

=== Cloud-init with userdata

For VMs, use cloud-init configuration to run commands during boot:

[source,yaml]
----
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    cores: 2
    memory: "4G"
    packages:
      - httpd
      - git
    userdata: |
      #cloud-config
      runcmd:
        - systemctl enable --now httpd
        - firewall-cmd --permanent --add-service=http
        - firewall-cmd --reload
        - echo "Welcome to the lab!" > /var/www/html/index.html
----

=== Container vs VM Command Execution

[cols="2,3,3"]
|===
|Resource Type |Command Field |Execution Timing

|**Containers**
|`commands:` (list)
|After container starts running

|**VMs** 
|`userdata:` (cloud-init)
|During VM boot process
|===

**Example Container Commands:**
[source,yaml]
----
containers:
  - name: "app"
    commands:
      - "dnf install -y git"  # ← Runs in running container
      - "systemctl start app"
----

**Example VM Commands:**
[source,yaml]
----
virtualmachines:
  - name: "server"
    userdata: |
      #cloud-config
      runcmd:
        - dnf install -y git   # ← Runs during VM boot
        - systemctl start app
----

== CRITICAL REQUIREMENT: Bastion Host

**At least ONE VM MUST be tagged with the "bastions" Ansible group for proper deployment.**

[source,yaml]
----
virtualmachines:
  - name: "management-server"    # At least one bastion required
    tags:
      - key: "AnsibleGroup"
        value: "bastions"        # ← REQUIRED for Zero Touch deployment
      - key: "ostype"
        value: "linux"
        
  - name: "web-server"          # Other VMs can use different groups
    tags:
      - key: "AnsibleGroup"
        value: "webservers"      # ← Different group OK
      - key: "ostype"
        value: "linux"
        
  - name: "database-server"     # Multiple groups possible
    tags:
      - key: "AnsibleGroup"
        value: "databases"       # ← Different group OK
      - key: "ostype"
        value: "linux"
----

**Why At Least One Bastion Is Required:**
- The Zero Touch deployer needs one "bastion" host for SSH access and management
- Bastions configure user accounts, terminal integration, and lab access
- Other VMs can use appropriate Ansible groups (webservers, databases, etc.)
- Without any bastion, the deployment will **fail completely**

== Common VM Configurations

=== Multi-Tier Lab Example

[source,yaml]
----
- name: "management-server"     # Bastion host (required)
  image: "rhel-9.6"
  cores: 2
  memory: "4G"
  tags:
    - key: "AnsibleGroup"
      value: "bastions"         # ← At least one bastion required
    - key: "ostype"
      value: "linux"
  networks:
    - management
    
- name: "web-server"           # Web tier
  image: "rhel-9.6"
  cores: 2
  memory: "4G"
  tags:
    - key: "AnsibleGroup"
      value: "webservers"       # ← Different group for web tier
    - key: "ostype"
      value: "linux"
  networks:
    - default
    - web-tier

- name: "database-server"      # Data tier
  image: "rhel-9.6"
  cores: 4
  memory: "8G"
  image_size: "200G"
  tags:
    - key: "AnsibleGroup"
      value: "databases"        # ← Different group for data tier
    - key: "ostype"
      value: "linux"
  networks:
    - data-tier
----

=== Single VM Lab Example

[source,yaml]
----
- name: "lab-server"           # Single VM serving as bastion
  image: "rhel-9.6"
  cores: 2
  memory: "4G"
  tags:
    - key: "AnsibleGroup"
      value: "bastions"         # ← Required for any lab
    - key: "ostype"
      value: "linux"
  networks:
    - default
----

== Common Ansible Groups

Choose appropriate Ansible groups based on your VM's role:

[cols="1,3"]
|===
|Ansible Group |Use Case

|`bastions`
|**Required** - Management servers, jump hosts, SSH access points

|`webservers`
|Apache, Nginx, application frontend servers

|`databases`
|PostgreSQL, MySQL, MongoDB, data storage servers

|`loadbalancers`
|HAProxy, Nginx load balancers, traffic distribution

|`monitoring`
|Prometheus, Grafana, monitoring and observability

|`applications`
|Custom application servers, microservices

|`development`
|Development workstations, IDE servers

|`testing`
|CI/CD runners, test environments
|===

== Exposing Services

Make services accessible from outside the lab:

[source,yaml]
----
- name: "web-server"
  image: "rhel-9.6"
  cores: 2
  memory: "4G"
  services:
    - name: web
      ports:
        - port: 80
          protocol: TCP
          targetPort: 80
          name: http
  routes:
    - name: web
      host: web
      service: web
      targetPort: 80
      tls: true
----

This creates a web-accessible URL for your service.

== User Configuration

Set up default users with cloud-init:

[source,yaml]
----
- name: "training-vm"
  image: "rhel-9.6"
  userdata: |
    #cloud-config
    users:
      - name: student
        sudo: ALL=(ALL) NOPASSWD:ALL
        lock_passwd: false
        passwd: "{{ common_password | password_hash('sha512') }}"
    
    packages:
      - vim
      - git
      - curl
----

== Multiple VMs Example

Create a complete environment:

[source,yaml]
----
---
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6" 
    cores: 2
    memory: "4G"
    networks:
      - default
      - web-tier
    services:
      - name: http
        ports:
          - port: 80
            protocol: TCP
            targetPort: 80
            name: http
    routes:
      - name: web
        host: web
        service: http
        targetPort: 80
        tls: true
        
  - name: "app-server"
    image: "rhel-9.6"
    cores: 4  
    memory: "6G"
    networks:
      - web-tier
      - app-tier
      
  - name: "database"
    image: "rhel-9.6"
    cores: 2
    memory: "8G" 
    image_size: "100G"
    networks:
      - app-tier
----

== Testing Your VMs

After deployment, verify VM configuration:

[source,bash]
----
# Check VM resources
free -h                    # Memory
nproc                     # CPU cores  
df -h                     # Disk space

# Test network connectivity
ip addr show              # Network interfaces
ping google.com           # Internet access
----

== Best Practices

=== Resource Allocation
* **Start small**: Begin with 2G RAM, expand as needed
* **Monitor usage**: Use `htop` and `df -h` to check utilization
* **Plan capacity**: Consider total resources across all VMs

=== Naming Conventions
* **Descriptive names**: `web-server` not `vm1`
* **Environment prefixes**: `dev-web-server`, `prod-database`
* **DNS-safe**: Use hyphens, not underscores

=== Network Design
* **Default access**: Include `default` network for internet
* **Logical grouping**: Group related VMs on custom networks
* **Security zones**: Separate tiers appropriately

== Troubleshooting

**VM won't start?**
→ Check resource limits and image name

**Can't access services?**
→ Verify services and routes configuration

**Out of memory?**
→ Reduce VM memory or increase lab resources

== Next Steps

Continue with the following topics:

**Build on VM Knowledge:**
* xref:container-basics.adoc[**Container Basics**] - Add lightweight services alongside your VMs
* xref:networking-basics.adoc[**Networking Basics**] - Create multi-network topologies for complex labs

**Apply in Practice:**  
* xref:module-2-1-single-vm-setup.adoc[**Module 2.1: Single VM Setup**] - Hands-on practice with VM deployment
* xref:template-customization-guide.adoc[**Template Customization Guide**] - Integrate VMs into complete lab designs

**Advanced VM Features:**
* xref:cnv-platform-features.adoc[**OpenShift CNV Platform Features**] - EFI boot, SecureBoot, enterprise configurations
* xref:enterprise-lab-patterns.adoc[**Enterprise Lab Patterns**] - Real-world VM patterns for Satellite, AAP

[bibliography]
== References

* [[[template-instances]]] Red Hat GPTE Team. Zero Touch Template Instance Configuration. 
  `https://github.com/rhpds/lab_zero_touch_template.git` - config/instances.yaml. 2024.

* [[[roadshow-instances]]] Red Hat Ansible Team. AAP 2.5 Roadshow Lab Instance Configuration. 
  AgnosticV Git Repository - zt-ans-bu-roadshow01/config/instances.yaml. 2024.

* [[[agnosticd-base]]] Red Hat GPTE Team. AgnosticD Zero Touch Base RHEL Configuration. 
  AgnosticD Git Repository - ansible/configs/zero-touch-base-rhel/default_vars_openshift_cnv.yaml. 2024.

== Related Documentation

* xref:firewall-basics.adoc[Firewall Configuration Basics] - Secure your VM deployments
* xref:production-patterns-guide.adoc[Production Lab Patterns Guide] - Professional VM configuration patterns
