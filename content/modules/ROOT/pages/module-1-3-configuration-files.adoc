
= Module 1.3: Configuration Files
:estimated-time: 10-15 minutes

== Learning Objectives

Upon completion, you will understand:

* YAML syntax and formatting rules
* Zero Touch configuration format requirements
* Variable patterns for different file types
* Configuration file validation and troubleshooting
* Common configuration patterns and best practices

== YAML Fundamentals

Zero Touch uses YAML files for all configuration. YAML is human-readable and follows specific formatting rules.

=== Basic YAML Syntax

==== Key-Value Pairs
.Basic YAML Key-Value Pairs <<template-instances>>
[source,yaml]
----
name: "web-server"
memory: "4G"
cores: 2
----

==== Lists (Arrays)
.YAML Array Syntax <<agnosticd-base>>
[source,yaml]
----
networks:
  - default
  - web-tier
  - database-tier
----

==== Nested Objects
.YAML Nested Object Structure <<roadshow-instances>>
[source,yaml]
----
virtualmachines:
  - name: "control"
    memory: "4G"
    networks:
      - default
----

==== Comments
.YAML Comment Syntax <<template-instances>>
[source,yaml]
----
# This is a comment
virtualmachines:
  - name: "web-server"  # Inline comment
    memory: "4G"
----

=== YAML Formatting Rules

**Critical Rules** (breaking these causes errors):

==== Indentation
* Use **spaces only** (never tabs)
* Use **2 spaces** per level
* Be **consistent** throughout the file

.YAML Indentation Examples <<agnosticd-base>>
[source,yaml]
----
# Correct
virtualmachines:
  - name: "server1"
    memory: "4G"
    networks:
      - default

# Wrong (inconsistent indentation)
virtualmachines:
- name: "server1"
  memory: "4G"
   networks:
    - default
----

==== Quotes
* Use quotes for **strings with special characters**
* Use quotes for **values that might be interpreted as numbers/booleans**

.YAML Quoting Best Practices <<template-instances>>
[source,yaml]
----
# Good practices
name: "web-server"
port: "8080"        # Quoted to ensure it's treated as string
memory: "4G"        # Quoted because of the 'G' suffix
enabled: true       # Boolean, no quotes needed

# Potential issues
name: web-server    # Works, but inconsistent
port: 8080          # Might be interpreted as number
version: 1.0        # Might become 1.0 instead of "1.0"
----

==== Lists vs Objects
[source,yaml]
----
# List of objects
virtualmachines:
  - name: "server1"
    memory: "4G"
  - name: "server2"
    memory: "2G"

# Common mistake (missing dash)
virtualmachines:
  name: "server1"    # This creates one object, not a list
  memory: "4G"
----

== Zero Touch Configuration Patterns

=== Variable Syntax Patterns

**CRITICAL**: Different files use different variable syntax patterns.

==== AgnosticD Files (instances.yaml, networks.yaml, firewall.yaml)

Use **Jinja2 templating** with **required quotes**:

.AgnosticD Variable Syntax <<roadshow-instances>>
[source,yaml]
----
# CORRECT in instances.yaml
environment:
  PASSWORD: "{{ common_password }}"      # ← Must be quoted
  DATABASE_URL: "{{ db_connection }}"    # ← Must be quoted

# WRONG - causes deployment failure  
environment:
  PASSWORD: {{ common_password }}        # ← Unquoted breaks YAML parsing
----

==== UI Configuration (ui-config.yml)

Use **shell-style variables** with **no quotes**:

.UI Configuration Variable Syntax <<satellite-ui>>
[source,yaml]
----
# CORRECT in ui-config.yml
tabs:
  - name: "Web App"
    url: https://webapp-${guid}.${domain}/    # ← Shell-style, no quotes

# WRONG for UI config
    url: https://webapp-{{ guid }}.{{ domain }}/  # ← Wrong syntax for UI
----

[IMPORTANT]
====
**Why This Matters**:

* **AgnosticD processes** configuration files during deployment using Ansible templating
* **Showroom processes** UI config during runtime using different variable substitution  
* **Wrong patterns cause deployment failures or broken URLs**
====

=== Standard File Structure

Each configuration file follows a consistent pattern:

==== `instances.yaml`
[source,yaml]
----
# Virtual machines (always a list)
virtualmachines:
  - name: "server-name"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    networks:
      - default
    # Optional configurations...

# Containers (optional list)
containers:
  - name: "app-container"
    image: "nginx:latest"
    # Container-specific config...
----

==== `networks.yaml`
.Network Configuration Structure <<agnosticd-base>>
[source,yaml]
----
---
# Default network exists by default, specify here always.
- name: default
- name: web-tier
  cidr: "10.1.0.0/24"
  description: "Frontend network"
- name: database-tier
  cidr: "10.2.0.0/24"
  description: "Backend network"
----

==== `firewall.yaml`
.Firewall Rules Configuration <<agnosticd-base>>
[source,yaml]
----
---
# By default egress traffic is not allowed, define below the ports allowed.
egress:
  - ports:
      - protocol: TCP
        port: 443
----

=== Configuration Validation

==== Required vs Optional Fields

Each configuration has required and optional fields:

.Required vs Optional VM Fields <<template-instances>>
[source,yaml]
----
virtualmachines:
  - name: "my-server"          # Required
    image: "rhel-9.6"          # Required  
    memory: "4G"               # Required
    cores: 2                   # Required
    image_size: "40G"          # Required
    networks:                  # Required
      - default
    
    # Optional fields
    packages:                  # Optional
      - git
      - vim
    tags:                      # Optional
      - key: "Environment"
        value: "Lab"
    bootloader: efi            # Optional
    disk_type: "scsi"          # Optional
----

==== Common Validation Errors

**Missing Required Fields**:
.Missing Required Fields Error <<template-instances>>
[source,yaml]
----
#  Error: Missing required fields
virtualmachines:
  - name: "test-server"
    # Missing: image, memory, cores, image_size, networks
----

**Invalid Data Types**:
.Invalid Data Type Error <<template-instances>>
[source,yaml]
----
#  Error: cores should be a number, not string
virtualmachines:
  - name: "test-server"
    cores: "two"        # Should be: cores: 2
----

**Invalid Network References**:
.Invalid Network Reference Error <<agnosticd-base>>
[source,yaml]
----
#  Error: network "frontend" not defined in networks.yaml
virtualmachines:
  - name: "test-server"
    networks:
      - frontend        # Must exist in networks.yaml
----

=== Best Practices

==== Naming Conventions

.Naming Convention Best Practices <<roadshow-instances>>
[source,yaml]
----
#  Good naming practices
virtualmachines:
  - name: "control-node"      # Descriptive, kebab-case
  - name: "web-server-01"     # Clear purpose, numbered
  - name: "database-primary"  # Role-based naming

#  Poor naming
virtualmachines:
  - name: "vm1"               # Not descriptive
  - name: "test_server"       # Mixed case style  
  - name: "MyServer"          # CamelCase (inconsistent)
----

==== Resource Planning

[source,yaml]
----
#  Appropriate resource allocation
virtualmachines:
  - name: "control-node"
    memory: "4G"              # Sufficient for management
    cores: 2
  - name: "database-server"
    memory: "8G"              # More for database workload
    cores: 4
  - name: "web-server"
    memory: "2G"              # Lighter for web serving
    cores: 1
----

==== Documentation

[source,yaml]
----
#  Well-documented configuration
virtualmachines:
  # Control node for Ansible automation
  - name: "control-node"
    image: "rhel-9.6"
    memory: "4G"              # Needs memory for Ansible operations
    cores: 2
    image_size: "40G"
    networks:
      - default
    packages:                 # Pre-install automation tools
      - ansible-core
      - git
      - vim
    tags:
      - key: "AnsibleGroup"   # Used by automation scripts
        value: "controllers"
----

== Configuration Validation Tools

=== YAML Syntax Checking

==== Online Tools
* **YAML Lint**: http://www.yamllint.com/
* **YAML Validator**: https://yamlchecker.com/

==== Command Line Tools
.YAML Validation Commands <<template-setup>>
[source,bash]
----
# If yamllint is available
yamllint config/instances.yaml

# Using Python (if available)
python -c "import yaml; yaml.safe_load(open('config/instances.yaml'))"

# Basic syntax check with any YAML-aware tool
----

=== Zero Touch Specific Validation

==== Check File Relationships
[source,bash]
----
# Ensure networks referenced in instances.yaml exist in networks.yaml
grep -h "networks:" -A 10 config/instances.yaml
cat config/networks.yaml
----

==== Verify Resource Totals
[source,bash]
----
# Calculate total memory allocation (example)
grep "memory:" config/instances.yaml
# Ensure total doesn't exceed cluster capacity
----

== Common Configuration Examples

=== Single VM Lab
.Simple Single VM Configuration <<template-instances>>
[source,yaml]
----
# instances.yaml
virtualmachines:
  - name: "lab-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    networks:
      - default

# networks.yaml
---
# Default network exists by default, specify here always.
- name: default

# firewall.yaml
---
egress:
  - ports:
      - protocol: TCP
        port: 443
ingress: []  # No inbound traffic allowed
----

=== Multi-VM Lab with Network Segmentation
[source,yaml]
----
# instances.yaml
virtualmachines:
  - name: "web-server"
    image: "rhel-9.6"
    memory: "2G"
    cores: 1
    image_size: "20G"
    networks:
      - web-tier
  - name: "database-server"
    image: "rhel-9.6"
    memory: "4G"
    cores: 2
    image_size: "40G"
    networks:
      - database-tier

# networks.yaml
---
- name: default
- name: web-tier
  cidr: "10.1.0.0/24"
- name: database-tier
  cidr: "10.2.0.0/24"

# firewall.yaml  
---
egress:
  - ports:
      - protocol: TCP
        port: 443
ingress:
  - ports:
      - protocol: TCP
        port: 8080  # Web traffic
      - protocol: TCP
        port: 5432  # Database traffic
----

==  Knowledge Check

Before moving to the next module, make sure you can:

- [ ] Write valid YAML with proper indentation and syntax
- [ ] Identify required vs optional fields in Zero Touch configs
- [ ] Understand the relationship between instances.yaml and networks.yaml
- [ ] Validate YAML syntax and catch common errors
- [ ] Follow naming conventions and best practices

== Practice Exercise

**Exercise**: Create a simple configuration for a web development lab:

1. **Design**: One VM for development, one container for database
2. **Configure**: Write the YAML files
3. **Validate**: Check your syntax and relationships

**Template to start**:
.Practice Exercise Template <<template-instances>>
[source,yaml]
----
# In instances.yaml
virtualmachines:
  - name: "dev-workstation"
    # Add your configuration here...

containers:
  - name: "postgres-db"
    # Add your configuration here...
----

== Next Steps

Now that you understand the configuration basics, put it into practice by creating your first lab.

**Next Module**: xref:module-2-1-single-vm-setup.adoc[2.1 Single VM Setup] (15-20 min)

== Related Resources

* xref:vm-basics.adoc[Adding Instances and Containers] (Reference)
* xref:networking-basics.adoc[Configuring Networking] (Reference)
* xref:firewall-basics.adoc[Configuring Firewall Rules] (Reference)

[bibliography]
== References

* [[[template-instances]]] Red Hat GPTE Team. Zero Touch Template Instance Configuration. 
  `https://github.com/rhpds/lab_zero_touch_template.git` - config/instances.yaml. 2024.

* [[[roadshow-instances]]] Red Hat Ansible Team. AAP 2.5 Roadshow Lab Instance Configuration. 
  AgnosticV Git Repository - zt-ans-bu-roadshow01/config/instances.yaml. 2024.

* [[[agnosticd-base]]] Red Hat GPTE Team. AgnosticD Zero Touch Base RHEL Configuration. 
  AgnosticD Git Repository - ansible/configs/zero-touch-base-rhel/default_vars_openshift_cnv.yaml. 2024.

* [[[satellite-ui]]] Red Hat Satellite Team. Satellite Advanced Topics 6.17 UI Configuration. 
  `/home/wilson/Projects/mad-scientist/tests/converted_labs/zt-satellite-advanced-topics-6-17/ui-config.yml`. 2024.

* [[[template-setup]]] Red Hat GPTE Team. Zero Touch Template Setup Automation. 
  `/home/wilson/Projects/zero_touch_template_wilson/setup-automation/main.yml`. 2024.
